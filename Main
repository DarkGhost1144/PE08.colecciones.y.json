import java.util.Scanner;
import java.util.InputMismatchException;

/**
 * Clase principal que contiene el punto de entrada del programa. Gestiona el
 * menú interactivo del sistema de alojamientos Javito, permitiendo al usuario
 * realizar operaciones CRUD sobre clientes y alojamientos.
 *
 * @author Jkur
 * @version 1.0
 */
public class Main {

    /**
     * Método principal que inicia la aplicación. Presenta un menú interactivo
     * al usuario y gestiona las opciones seleccionadas.
     *
     * @param args Argumentos de línea de comandos (no utilizados)
     */
    public static void main(String[] args) {
        Javito sistema = new Javito();  // Sistema de gestión
        Scanner sc = new Scanner(System.in);  // Lector de entrada
        int opcion = -1;  // Opción seleccionada por el usuario

        // Carga inicial de datos de prueba para facilitar las pruebas
        cargarDatosDePrueba(sistema);

        // Bucle principal del menú
        do {
            try {
                mostrarMenu();  // Muestra las opciones disponibles
                opcion = sc.nextInt();  // Lee la opción elegida
                sc.nextLine();  // Limpia el buffer del scanner tras leer el entero

                // Procesa la opción seleccionada
                switch (opcion) {
                    case 1:
                        // Alta de cliente con datos introducidos manualmente
                        altaClienteManual(sistema, sc);
                        break;
                    case 2:
                        // Baja de cliente por DNI
                        bajaClienteManual(sistema, sc);
                        break;
                    case 3:
                        // Listado alfabético de clientes
                        sistema.listadoClientes();
                        break;
                    case 4:
                        // Ranking de clientes más fieles
                        System.out.println("\n--- Top Clientes (Más alojados) ---");
                        sistema.topClientes();
                        break;
                    case 5:
                        // Alta de alojamiento con datos manuales
                        altaAlojamientoManual(sistema, sc);
                        break;
                    case 6:
                        // Baja de alojamiento por nombre
                        bajaAlojamientoManual(sistema, sc);
                        break;
                    case 7:
                        // Listado de alojamientos
                        sistema.listadoAlojamientos();
                        break;
                    case 8:
                        // Ranking de alojamientos
                        System.out.println("\n--- Top Alojamientos ---");
                        sistema.topAlojamientos();
                        break;
                    case 9:
                        // Submenú de gestión JSON
                        System.out.println("\n--- Gestión JSON ---");
                        System.out.println("1. Exportar todo a JSON");
                        System.out.println("2. Importar todo desde JSON");
                        System.out.print("Elige: ");
                        int subJson = sc.nextInt();

                        if (subJson == 1) {
                            // Exporta clientes y alojamientos a JSON
                            sistema.exportClientesToJSON();
                            sistema.exportAlojamientoToJSON();
                        } else if (subJson == 2) {
                            // Importa clientes y alojamientos desde JSON
                            sistema.importClientesFromJSON();
                            sistema.importAlojamientosFromJSON();
                        }
                        break;
                    case 0:
                        // Finaliza el programa
                        System.out.println("Saliendo del sistema...");
                        break;
                    default:
                        // Opción no válida
                        System.out.println("Opción no válida.");
                }

            } catch (InputMismatchException e) {
                // Error al introducir un valor no numérico
                System.out.println("Error: Debes introducir un número.");
                sc.nextLine();  // Limpia el buffer tras el error
            } catch (Exception e) {
                // Captura cualquier otro error inesperado
                System.out.println("Ha ocurrido un error inesperado: " + e.getMessage());
            }

            // Pausa antes de mostrar el menú nuevamente (excepto al salir)
            if (opcion != 0) {
                System.out.println("\nPresiona ENTER para continuar...");
                sc.nextLine();
            }

        } while (opcion != 0);  // Continúa hasta que el usuario elija salir

        sc.close();  // Cierra el scanner al finalizar
    }

    /**
     * Muestra el menú principal del sistema. Presenta todas las opciones
     * disponibles al usuario de forma estructurada.
     */
    private static void mostrarMenu() {
        System.out.println("\n#################################");
        System.out.println("### GESTIÓN DE ALOJAMIENTOS JAVITO ###");
        System.out.println("#################################");
        System.out.println("1. Alta Cliente");
        System.out.println("2. Baja Cliente (por DNI)");
        System.out.println("3. Listar Clientes (Orden Alfabético)");
        System.out.println("4. Ver Top Clientes (Más fieles)");
        System.out.println("---------------------------------");
        System.out.println("5. Alta Alojamiento");
        System.out.println("6. Baja Alojamiento (por Nombre)");
        System.out.println("7. Listar Alojamientos");
        System.out.println("8. Ver Top Alojamientos");
        System.out.println("---------------------------------");
        System.out.println("9. Importar/Exportar JSON");
        System.out.println("0. Salir");
        System.out.print("Seleccione una opción: ");
    }

    /**
     * Solicita datos de un nuevo cliente al usuario y lo registra en el
     * sistema. Incluye validación mediante los setters de la clase Cliente.
     *
     * @param sistema Instancia del sistema de gestión
     * @param sc Scanner para leer la entrada del usuario
     */
    private static void altaClienteManual(Javito sistema, Scanner sc) {
        System.out.println("\n--- Alta de Cliente ---");

        // Solicita los datos básicos del cliente
        System.out.print("Nombre: ");
        String nombre = sc.nextLine();

        System.out.print("DNI (8 números + Letra): ");
        String dni = sc.nextLine();

        System.out.print("Email: ");
        String email = sc.nextLine();

        System.out.print("Lugar de Residencia: ");
        String residencia = sc.nextLine();

        // Crea el cliente (con validación automática de DNI y email)
        Cliente c = new Cliente(nombre, dni, email, residencia);

        // Opción para simular historial de visitas (solo para pruebas)
        System.out.print("Simular visitas previas? (0 para no): ");
        try {
            int visitas = Integer.parseInt(sc.nextLine());
            c.setNumVecesAlojado(visitas);  // Establece el número de visitas
        } catch (NumberFormatException e) {
            // Si no introduce un número, se ignora (mantiene 0 visitas)
        }

        // Intenta añadir el cliente al sistema
        if (sistema.altaCliente(c)) {
            System.out.println("Cliente añadido correctamente.");
            // Muestra cómo quedó el objeto tras las validaciones
            System.out.println("Datos guardados: " + c);
        } else {
            System.out.println("Error: No se pudo añadir (Array lleno o dato nulo).");
        }
    }

    /**
     * Solicita un DNI al usuario y elimina el cliente correspondiente del
     * sistema.
     *
     * @param sistema Instancia del sistema de gestión
     * @param sc Scanner para leer la entrada del usuario
     */
    private static void bajaClienteManual(Javito sistema, Scanner sc) {
        System.out.print("Introduce el DNI del cliente a borrar: ");
        String dni = sc.nextLine();

        // Intenta eliminar el cliente
        if (sistema.bajaCliente(dni)) {
            System.out.println("Cliente eliminado.");
        } else {
            System.out.println("No se encontró ningún cliente con ese DNI.");
        }
    }

    /**
     * Solicita datos de un nuevo alojamiento al usuario y lo registra en el
     * sistema. Incluye manejo de errores de formato en los datos numéricos.
     *
     * @param sistema Instancia del sistema de gestión
     * @param sc Scanner para leer la entrada del usuario
     */
    private static void altaAlojamientoManual(Javito sistema, Scanner sc) {
        System.out.println("\n--- Alta de Alojamiento ---");

        System.out.print("Nombre del alojamiento: ");
        String nombre = sc.nextLine();

        // Valores por defecto en caso de error
        int capacidad = 0;
        double tarifa = 0;
        boolean chimenea = false;
        boolean jacuzzi = false;

        try {
            // Solicita datos numéricos y booleanos
            System.out.print("Capacidad (personas): ");
            capacidad = Integer.parseInt(sc.nextLine());

            System.out.print("Tarifa (euros): ");
            tarifa = Double.parseDouble(sc.nextLine());

            System.out.print("Tiene Chimenea? (true/false): ");
            chimenea = Boolean.parseBoolean(sc.nextLine());

            System.out.print("Tiene Jacuzzi? (true/false): ");
            jacuzzi = Boolean.parseBoolean(sc.nextLine());

        } catch (NumberFormatException e) {
            // Error en conversión numérica: usa valores por defecto
            System.out.println("Error en formato de números. Se usarán valores 0/false.");
        }

        // Crea el alojamiento con los datos proporcionados
        Alojamiento a = new Alojamiento(nombre, capacidad, tarifa, chimenea, jacuzzi);

        // Intenta añadir el alojamiento
        if (sistema.altaAlojamiento(a)) {
            System.out.println("Alojamiento creado exitosamente.");
        } else {
            System.out.println("Error: No se pudo añadir (Array lleno).");
        }
    }

    /**
     * Solicita un nombre de alojamiento al usuario y lo elimina del sistema.
     *
     * @param sistema Instancia del sistema de gestión
     * @param sc Scanner para leer la entrada del usuario
     */
    private static void bajaAlojamientoManual(Javito sistema, Scanner sc) {
        System.out.print("Introduce el nombre del alojamiento a borrar: ");
        String nombre = sc.nextLine();

        // Intenta eliminar el alojamiento
        if (sistema.bajaAlojamiento(nombre)) {
            System.out.println("Alojamiento eliminado.");
        } else {
            System.out.println("No se encontró el alojamiento.");
        }
    }

    /**
     * Carga datos de prueba en el sistema para facilitar las demostraciones.
     * Incluye 2 clientes y 2 alojamientos con datos ficticios.
     *
     * @param sistema Instancia del sistema donde cargar los datos
     */
    private static void cargarDatosDePrueba(Javito sistema) {
        // Crea clientes de prueba
        Cliente c1 = new Cliente("Jakub Kurkowski", "12345678Z", "ana@test.com", "Madrid");
        c1.alojar();  // Simula 1 visita

        Cliente c2 = new Cliente("Marxo Amian", "87654321A", "berto@test.com", "Barcelona");
        c2.setNumVecesAlojado(5);  // Simula 5 visitas

        // Añade los clientes al sistema
        sistema.altaCliente(c1);
        sistema.altaCliente(c2);

        // Crea alojamientos de prueba
        Alojamiento a1 = new Alojamiento("Cabaña Bosque", 4, 120.0, true, false);
        Alojamiento a2 = new Alojamiento("Suite Deluxe", 2, 250.0, true, true);

        // Simula que la cabaña está actualmente alquilada
        a1.alquilar();

        // Añade los alojamientos al sistema
        sistema.altaAlojamiento(a1);
        sistema.altaAlojamiento(a2);
    }
}
